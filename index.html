<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>注专转 专 专祝 拽爪注转</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 1100px; margin: auto; padding-top: 75px; }
        .sticky-header { position: fixed; top: 0; left: 0; right: 0; background: #fff; z-index: 1000; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-menu { display: flex; gap: 8px; max-width: 1100px; margin: auto; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .tab-btn.active { background: #1a73e8; color: white; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.8rem; font-weight: bold; margin-bottom: 3px; color: #444; }
        input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .save-btn { background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .table-wrapper { overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .chart-card { background: white; padding: 15px; border-radius: 12px; height: 280px; }
        canvas { width: 100% !important; height: 200px !important; }
        .in-range { background: #e6ffed !important; }
        .out-of-range { background: #ffdce0 !important; }
        .td-bad { color: #d93025; font-weight: bold; background-color: #fce8e6; }
        .td-good { color: #188038; font-weight: bold; background-color: #e6ffed; }
        .event-item { background: #fff3cd; padding: 8px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .photo-item img { width: 100%; border-radius: 8px; aspect-ratio: 1; object-fit: cover; }
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 3px 7px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="tab-menu">
        <button class="tab-btn active" onclick="switchSystem('注专转 1', this)">注专转 1</button>
        <button class="tab-btn" onclick="switchSystem('注专转 2', this)">注专转 2</button>
        <button class="tab-btn" onclick="switchSystem('注专转 3', this)">注专转 3</button>
        <button class="tab-btn" onclick="switchSystem('注专转 4', this)">注专转 4</button>
    </div>
</div>

<div class="container">
    <h1 id="appTitle" contenteditable="true" onblur="saveTitle()" style="text-align:center; color:#1a73e8;"> 砖</h1>

    <div class="card">
        <h2>И 转 转 - <span id="currentSysName">注专转 1</span></h2>
        <div class="input-group" style="margin-bottom:15px;"><label>转专</label><input type="date" id="logDate" onchange="loadData()"></div>
        <div class="grid">
            <div class="input-group"><label>转</label><input type="number" id="vSal" step="0.1" oninput="val(this,33.5,37.5)"></div>
            <div class="input-group"><label>驻'</label><input type="number" id="vTemp" step="0.1" oninput="val(this,23.5,26.5)"></div>
            <div class="input-group"><label>pH</label><input type="number" id="vPH" step="0.01" oninput="val(this,7.5,8.9)"></div>
        </div>
        <div class="grid">
            <div class="input-group"><label></label><input type="number" id="vMg"></div>
            <div class="input-group"><label>拽转</label><input type="number" id="vAlk" step="0.1"></div>
            <div class="input-group"><label>拽爪</label><input type="number" id="vCa"></div>
            <div class="input-group"><label>专</label><input type="number" id="vNO2" step="0.01"></div>
            <div class="input-group"><label>专</label><input type="number" id="vNO3" step="0.1"></div>
            <div class="input-group"><label>驻住驻</label><input type="number" id="vPO4" step="0.01"></div>
        </div>
        <button class="save-btn" onclick="saveAll()">砖专   注</button>
    </div>

    <div class="card">
        <h2> 住专</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>转专</th><th>转</th><th>驻'</th><th>pH</th><th>Mg</th><th>Alk</th><th>Ca</th><th>NO2</th><th>NO3</th><th>PO4</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card"><h3>转</h3><canvas id="cSal"></canvas></div>
        <div class="chart-card"><h3>驻专专</h3><canvas id="cTemp"></canvas></div>
        <div class="chart-card"><h3>pH</h3><canvas id="cPH"></canvas></div>
	<div class="chart-card"><h3></h3><canvas id="c"></canvas></div>
	<div class="chart-card"><h3>拽转</h3><canvas id="c拽转"></canvas></div>
	<div class="chart-card"><h3>拽爪</h3><canvas id="c拽爪"></canvas></div>
	<div class="chart-card"><h3>专</h3><canvas id="c专"></canvas></div>
	<div class="chart-card"><h3>专</h3><canvas id="c专"></canvas></div>
	<div class="chart-card"><h3>驻住驻</h3><canvas id="c驻住驻"></canvas></div>
    </div>
</div>

<script>
    // 拽 专转
    let db = JSON.parse(localStorage.getItem('coralDB_v7')) || { title:" 砖", logs:[], events:[], photos:[] };
    let curSys = '注专转 1';
    let charts = {};

    document.getElementById('appTitle').innerText = db.title;
    document.getElementById('logDate').valueAsDate = new Date();

    function saveTitle() { db.title = document.getElementById('appTitle').innerText; sync(); }
    function sync() { localStorage.setItem('coralDB_v7', JSON.stringify(db)); }

    function val(el, min, max) {
        let v = parseFloat(el.value);
        el.className = isNaN(v) ? "" : (v >= min && v <= max ? "in-range" : "out-of-range");
    }

    function switchSystem(sys, btn) {
        curSys = sys;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('currentSysName').innerText = sys;
        loadData(); render();
    }

    function loadData() {
        let d = document.getElementById('logDate').value;
        let daily = db.logs.find(l => l.sys === curSys && l.date === d) || {};
        ['Sal','Temp','PH','Mg','Alk','Ca','NO2','NO3','PO4'].forEach(f => {
            document.getElementById('v'+f).value = daily[f] || '';
        });
    }

    function saveAll() {
        let d = document.getElementById('logDate').value;
        if(!d) return alert("专 转专");

        db.logs = db.logs.filter(l => !(l.sys === curSys && l.date === d));
        let entry = { sys: curSys, date: d };
        ['Sal','Temp','PH','Mg','Alk','Ca','NO2','NO3','PO4'].forEach(f => {
            entry[f] = document.getElementById('v'+f).value;
        });
        
        db.logs.push(entry);
        sync();
        render();

        if (window.syncToFirebase) {
            window.syncToFirebase(entry);
        } else {
            console.error("Firebase not ready");
        }
    }

    function render() {
        let logs = db.logs.filter(l => l.sys === curSys).sort((a,b)=>new Date(b.date)-new Date(a.date));
        const check = (v, min, max) => {
            let n = parseFloat(v);
            return (n >= min && n <= max) ? "td-good" : (v ? "td-bad" : "");
        };

        document.getElementById('tableBody').innerHTML = logs.map(l => `
            <tr>
                <td><b>${l.date}</b></td>
                <td class="${check(l.Sal, 33.5, 37.5)}">${l.Sal || '-'}</td>
                <td class="${check(l.Temp, 23.5, 26.5)}">${l.Temp || '-'}</td>
                <td class="${check(l.PH, 7.5, 8.9)}">${l.PH || '-'}</td>
                <td>${l.Mg || '-'}</td><td>${l.Alk || '-'}</td><td>${l.Ca || '-'}</td>
                <td>${l.NO2 || '-'}</td><td>${l.NO3 || '-'}</td><td>${l.PO4 || '-'}</td>
            </tr>
        `).join('');
        updateCharts();
    }

    function updateCharts() {
        let logs = db.logs.filter(l => l.sys === curSys).sort((a,b)=>new Date(a.date)-new Date(b.date));
        const build = (id, label, key, color) => {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id).getContext('2d'), {
                type: 'line',
                data: { 
                    labels: logs.map(l => l.date), 
                    datasets: [{ label, data: logs.map(l => l[key]), borderColor: color, tension:0.3 }] 
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };
        build('cSal', '转', 'Sal', '#1a73e8');
        build('cTemp', '驻专专', 'Temp', '#fabb05');
        build('cPH', 'pH', 'PH', '#1abc9c');
	build('c', '', 'PH', '#4169E1');
	build('c拽转', '拽转', 'PH', '#2E8B57');
	build('c拽爪', '拽爪', 'PH', '#FF7F50');
	build('c专', '专', 'PH', '#FFD700');
	build('c专', '专', 'PH', '#9966CC');
	build('c驻住驻', '驻住驻', 'PH', '#FF8C00');




    }

    window.onload = () => { render(); loadData(); };
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCRZZi25XJxnwKAghrv4NEJyDqIG4orcZ0",
        authDomain: "coralreefmonitoring.firebaseapp.com",
        projectId: "coralreefmonitoring",
        storageBucket: "coralreefmonitoring.firebasestorage.app",
        messagingSenderId: "35860394984",
        appId: "1:35860394984:web:c086282e5cab3e70eb2a5d"
    };

    const app = initializeApp(firebaseConfig);
    const cloudDB = getFirestore(app);

    // 砖驻转 驻拽爪 注 爪
    window.syncToFirebase = async (entry) => {
        try {
            const docId = `${entry.sys}_${entry.date}`;
            await setDoc(doc(cloudDB, "reefLogs", docId), entry);
            console.log("砖专 注!");
        } catch (e) { console.error("砖转 注:", e); }
    };

    // 注 专砖转 注
    async function loadFromCloud() {
        try {
            const snap = await getDocs(collection(cloudDB, "reefLogs"));
            let cloudLogs = [];
            snap.forEach(d => cloudLogs.push(d.data()));
            if(cloudLogs.length > 0) {
                //  转 (注 爪)
                db.logs = cloudLogs;
                localStorage.setItem('coralDB_v7', JSON.stringify(db));
                if(typeof render === 'function') render();
            }
        } catch(e) { console.error("注 砖:", e); }
    }
    loadFromCloud();
</script>

</body>
</html>